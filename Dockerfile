FROM maven as builder

COPY log4j-vulnerability-demo /log4j-vulnerability-demo

WORKDIR /log4j-vulnerability-demo/
RUN mvn clean package

FROM centos:7
ARG TOMCAT_MAJOR_VERSION=8
ARG TOMCAT_MINOR_VERSION=8.5.34


COPY startUpScript.sh /
COPY attack.sh /
COPY commandsfile /
COPY LICENSE /
COPY log4j-exploit /log4j-exploit

RUN yum -y install wget \
    && yum -y install unzip \
    && yum install -y nc python2 \
    && yum -y install java-1.8.0-openjdk-devel \
    && wget -q https://archive.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR_VERSION/v$TOMCAT_MINOR_VERSION/bin/apache-tomcat-$TOMCAT_MINOR_VERSION.zip -P /etc/ \
    && unzip -q /etc/apache-tomcat-$TOMCAT_MINOR_VERSION.zip -d /etc/ \
    && mv /etc/apache-tomcat-$TOMCAT_MINOR_VERSION /etc/apache-tomcat \
    && rm /etc/apache-tomcat-$TOMCAT_MINOR_VERSION.zip \
    && rm -rf /etc/apache-tomcat/webapps/* \
    && chown root /startUpScript.sh \
    && chgrp root /startUpScript.sh \
    && chmod 777 /startUpScript.sh \
    && chmod 777 /attack.sh \
    #&& wget -q http://mirrors.estointernet.in/apache//jmeter/binaries/apache-jmeter-5.1.zip -P / \
   # && wget -q  https://www.apache.org/dist/jmeter/binaries/apache-jmeter-5.2.zip  -P / \
   # && unzip -q /apache-jmeter-5.2.zip -d / \
   # && rm /apache-jmeter-5.2.zip \
    && yum clean all \
    && cd /log4j-exploit/ \
    && javac Exploit.java

#COPY tomcatConfig/server.xml /etc/apache-tomcat/conf/

COPY --from=builder /log4j-vulnerability-demo/target/log4j-0.0.1-SNAPSHOT.war /etc/apache-tomcat/webapps/log4j-demo.war

COPY Test-Plan.jmx /

WORKDIR /

ENV TOMCAT_VERSION=${TOMCAT_MINOR_VERSION}

ENV K2_OPTS=""

CMD ["/bin/bash","-c","/startUpScript.sh && tail -f /dev/null"]
